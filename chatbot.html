<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMark1 - AI ì‘ì—…ìš”ì²­ Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .session-controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .session-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        #sessionStatus {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .context-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px;
            font-size: 13px;
        }

        .context-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .context-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-label {
            font-weight: 500;
            color: #6c757d;
            min-width: 60px;
        }

        .context-value {
            color: #495057;
            font-weight: 400;
        }

        .context-value.confirmed {
            color: #28a745;
            font-weight: 500;
        }

        .context-value.missing {
            color: #dc3545;
            font-style: italic;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e9ecef;
        }

        .recommendations-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }

        .recommendations-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .recommendations-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #333;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.bot .message-bubble {
            background: #f1f3f4;
            border: 1px solid #e9ecef;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .recommendation-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .recommendation-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
        }

        .recommendation-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .recommendation-radio {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendation-radio.selected {
            border-color: #667eea;
        }

        .recommendation-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #667eea;
        }

        .recommendation-content {
            margin-right: 40px;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-itemno {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .recommendation-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .score-high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .score-medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
        }
        
        .score-low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%) !important;
        }

        .recommendation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .recommendation-field {
            display: flex;
            flex-direction: column;
        }

        .recommendation-field label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .recommendation-field input {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            background: #f8f9fa;
        }

        .recommendation-field input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .examples-section {
            background: #f8f9fa;
            padding: 15px 20px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .examples-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .examples-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .example-item:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .input-field {
            flex: 1;
        }

        .input-field input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-field input:focus {
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .complete-btn {
            background: linear-gradient(135deg, #6bcf7f 0%, #4caf50 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .complete-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .work-details-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .work-details-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .work-field {
            margin-bottom: 15px;
        }

        .work-field label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .work-field input,
        .work-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .work-field textarea {
            height: 80px;
            resize: vertical;
        }

        .work-field input:focus,
        .work-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .no-recommendations {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PMark1 - AI ì‘ì—…ìš”ì²­ Assistant</h1>
            <p>ìì—°ì–´ë¡œ ì‘ì—…ìš”ì²­ì„ ì…ë ¥í•˜ë©´ AIê°€ ìœ ì‚¬í•œ ì´ë ¥ì„ ì°¾ì•„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤</p>
            <div class="session-controls">
                <div class="session-info">
                    <span id="sessionStatus">ì„¸ì…˜ ì¤€ë¹„ ì¤‘...</span>
                    <button class="session-btn" onclick="startNewSession()">ìƒˆ ì„¸ì…˜</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="context-panel" id="contextPanel">
                    <div class="context-header">ğŸ“ ìˆ˜ì§‘ëœ ì •ë³´</div>
                    <div class="context-content" id="contextContent">
                        <div class="context-item">
                            <span class="context-label">ìœ„ì¹˜:</span>
                            <span class="context-value" id="contextLocation">âŒ ë¯¸í™•ì¸</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">ì„¤ë¹„ìœ í˜•:</span>
                            <span class="context-value" id="contextEquipment">âŒ ë¯¸í™•ì¸</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">í˜„ìƒì½”ë“œ:</span>
                            <span class="context-value" id="contextStatus">âŒ ë¯¸í™•ì¸</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">ìš°ì„ ìˆœìœ„:</span>
                            <span class="context-value" id="contextPriority">âšª ë¯¸ì§€ì •</span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-bubble">
                            ì•ˆë…•í•˜ì„¸ìš”! PMark1 AI Assistantì…ë‹ˆë‹¤. ğŸš€<br><br>
                            ì‘ì—…ìš”ì²­ì„ ìì—°ì–´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆì‹œ:<br>
                            â€¢ "No.1 PEì˜ Pressure Vesselì— ê³ ì¥ ë°œìƒ"<br>
                            â€¢ "44043-CA1-6\"-P, Leak ë³¼íŒ… ì‘ì—…"<br>
                            â€¢ "ì„ìœ ì œí’ˆë°°í•©/ì €ì¥ì˜ Motor Operated Valve, ì‘ë™ë¶ˆëŸ‰"<br><br>
                            ğŸ’¡ <strong>ë©€í‹°í„´ ëŒ€í™” ì§€ì›:</strong> ì •ë³´ë¥¼ ë‹¨ê³„ë³„ë¡œ ì…ë ¥í•˜ì…”ë„ ë©ë‹ˆë‹¤!<br>
                            ì˜ˆ: "No.1 PE" â†’ "ì••ë ¥ë² ì ¤" â†’ "ê³ ì¥"
                        </div>
                        <div class="message-time" id="currentTime"></div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="examples-section">
                        <div class="examples-title">ğŸ’¡ ì…ë ¥ ì˜ˆì‹œ</div>
                        <div class="examples-list">
                            <div class="example-item" onclick="useExample(this)">No.1 PEì˜ Pressure Vesselì— ê³ ì¥ ë°œìƒ</div>
                            <div class="example-item" onclick="useExample(this)">ì„ìœ ì œí’ˆë°°í•©/ì €ì¥ì˜ Motor Operated Valve, ì‘ë™ë¶ˆëŸ‰</div>
                            <div class="example-item" onclick="useExample(this)">44043-CA1-6"-P, Leak ë³¼íŒ… ì‘ì—…</div>
                            <div class="example-item" onclick="useExample(this)">í•©ì„±ìˆ˜ì§€ í¬ì¥, Conveyor, ê³ ì¥</div>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-field">
                            <input type="text" id="messageInput" placeholder="ì‘ì—…ìš”ì²­ì„ ìì—°ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                        </div>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                </div>
            </div>

            <div class="recommendations-section">
                <div class="recommendations-header">
                    ğŸ“‹ ì¶”ì²œ ì‘ì—…ìš”ì²­ ì´ë ¥
                </div>
                <div class="recommendations-area" id="recommendationsArea">
                    <div class="no-recommendations">ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìœ ì‚¬í•œ ì‘ì—…ìš”ì²­ ì´ë ¥ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let conversationHistory = [];
        let currentRecommendations = [];
        let selectedRecommendation = null;
        let isLoading = false;
        let sessionId = null; // ì„¸ì…˜ ID ì¶”ì 

        // ë°±ì—”ë“œ URL (ê¸°ì¡´ í”„ë¡œì íŠ¸ì™€ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ í¬íŠ¸ ë³€ê²½)
        // ë°±ì—”ë“œ URL ì„¤ì • (í™˜ê²½ì— ë”°ë¼ ìë™ ê°ì§€)
        const getBackendUrl = () => {
            const currentPort = window.location.port;
            const currentHost = window.location.hostname;
            
            // í”„ë¡ íŠ¸ì—”ë“œê°€ 3001 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë©´ ë°±ì—”ë“œëŠ” 8001
            if (currentPort === '3001') {
                return `http://${currentHost}:8001/api/v1`;
            }
            // í”„ë¡ íŠ¸ì—”ë“œê°€ 3000 í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë©´ ë°±ì—”ë“œëŠ” 8000
            else if (currentPort === '3000') {
                return `http://${currentHost}:8000/api/v1`;
            }
            // ê¸°ë³¸ê°’
            else {
                return `http://${currentHost}:8001/api/v1`;
            }
        };
        
        const backendUrl = getBackendUrl();

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR');
            document.getElementById('currentTime').textContent = timeString;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('ko-KR');
        }

        function useExample(element) {
            const text = element.textContent;
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        function addMessageToChat(type, content, isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (isLoading) {
                bubbleDiv.innerHTML = '<div class="loading">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>';
            } else {
                bubbleDiv.textContent = content;
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = getCurrentTime();
            
            messageDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(timeDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        function showRecommendations(data) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsArea.innerHTML = '';
                
                data.recommendations.forEach((rec, index) => {
                    const recDiv = createRecommendationElement(rec, index);
                    recommendationsArea.appendChild(recDiv);
                });
                
                // Add complete button
                const completeBtnDiv = document.createElement('div');
                completeBtnDiv.innerHTML = `
                    <button class="complete-btn" onclick="completeWorkOrder()" disabled>
                        ì‘ì„± ì™„ë£Œ
                    </button>
                `;
                recommendationsArea.appendChild(completeBtnDiv);
                
                currentRecommendations = data.recommendations;
            } else {
                recommendationsArea.innerHTML = '<div class="no-recommendations">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        function createRecommendationElement(rec, index) {
            const recDiv = document.createElement('div');
            recDiv.className = 'recommendation-item';
            recDiv.onclick = () => selectRecommendation(index);
            
            // ìœ ì‚¬ë„ ì ìˆ˜ë¥¼ í¼ì„¼íŠ¸ë¡œ í‘œì‹œí•˜ê³  ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„
            const scorePercent = Math.round(rec.score * 100);
            let scoreClass = 'score-low';
            if (scorePercent >= 80) scoreClass = 'score-high';
            else if (scorePercent >= 60) scoreClass = 'score-medium';
            
            recDiv.innerHTML = `
                <div class="recommendation-radio" id="radio-${index}"></div>
                <div class="recommendation-content">
                    <div class="recommendation-header">
                        <div class="recommendation-itemno">
                            <label>ITEMNO</label>
                            <input type="text" value="${rec.itemno}" onchange="updateRecommendation(${index}, 'itemno', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-score ${scoreClass}">${scorePercent}%</div>
                    </div>
                    <div class="recommendation-details">
                        <div class="recommendation-field">
                            <label>ìœ„ì¹˜</label>
                            <input type="text" value="${rec.location}" onchange="updateRecommendation(${index}, 'location', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>ì„¤ë¹„ìœ í˜•</label>
                            <input type="text" value="${rec.equipType}" onchange="updateRecommendation(${index}, 'equipType', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>í˜„ìƒì½”ë“œ</label>
                            <input type="text" value="${rec.statusCode}" onchange="updateRecommendation(${index}, 'statusCode', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>ìš°ì„ ìˆœìœ„</label>
                            <input type="text" value="${rec.priority}" onchange="updateRecommendation(${index}, 'priority', this.value)" onclick="event.stopPropagation()">
                        </div>
                    </div>
                </div>
            `;
            
            return recDiv;
        }

        function selectRecommendation(index) {
            // Remove previous selection
            document.querySelectorAll('.recommendation-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.recommendation-radio').forEach(radio => {
                radio.classList.remove('selected');
            });
            
            // Add new selection
            const selectedItem = document.querySelectorAll('.recommendation-item')[index];
            const selectedRadio = document.getElementById(`radio-${index}`);
            
            selectedItem.classList.add('selected');
            selectedRadio.classList.add('selected');
            
            selectedRecommendation = { ...currentRecommendations[index] };
            
            // Enable complete button
            document.querySelector('.complete-btn').disabled = false;
        }

        function updateRecommendation(index, field, value) {
            currentRecommendations[index][field] = value;
            if (selectedRecommendation && document.querySelectorAll('.recommendation-item')[index].classList.contains('selected')) {
                selectedRecommendation[field] = value;
            }
        }

        async function completeWorkOrder() {
            if (!selectedRecommendation) return;
            
            try {
                // ê¸°ì¡´ ì‘ì—…ìš”ì²­ ì™„ì„± ëŒ€ì‹  ì‘ì—…ëª…/ìƒì„¸ ìƒì„±
                const response = await fetch(`${backendUrl}/generate-work-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_recommendation: selectedRecommendation,
                        user_message: conversationHistory[conversationHistory.length - 2]?.content || '',
                        session_id: sessionId // ì„¸ì…˜ ID í¬í•¨
                    })
                });

                if (!response.ok) {
                    throw new Error('ì‘ì—…ëª…/ìƒì„¸ ìƒì„± ì‹¤íŒ¨');
                }

                const result = await response.json();
                
                // ì¶”ì²œ ê²°ê³¼ ì˜ì—­ì„ ì‘ì—…ëª…/ìƒì„¸ í¸ì§‘ ì˜ì—­ìœ¼ë¡œ ë³€ê²½
                showWorkDetailsEditor(result);
                
                // ëŒ€í™”ì°½ì— ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
                addMessageToChat('bot', 'ì‘ì—…ëª…ê³¼ ì‘ì—…ìƒì„¸ë‚´ìš©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”. ì™„ë£Œë˜ë©´ "í™•ì •" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                
            } catch (error) {
                console.error('Error generating work details:', error);
                addMessageToChat('bot', 'ì‘ì—…ëª…/ìƒì„¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function showWorkDetailsEditor(workDetails) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            
            recommendationsArea.innerHTML = `
                <div class="work-details-section">
                    <div class="work-details-header">
                        ğŸ“ ì‘ì—…ëª…ê³¼ ì‘ì—…ìƒì„¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”
                    </div>
                    
                    <div class="work-field">
                        <label for="workTitle">ì‘ì—…ëª…</label>
                        <input type="text" id="workTitle" value="${workDetails.work_title}" placeholder="ì‘ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    
                    <div class="work-field">
                        <label for="workDetails">ì‘ì—…ìƒì„¸</label>
                        <textarea id="workDetails" placeholder="ì‘ì—…ìƒì„¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${workDetails.work_details}</textarea>
                    </div>
                    
                    <button class="confirm-btn" onclick="finalizeWorkOrder()">
                        í™•ì •
                    </button>
                </div>
            `;
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('workTitle').focus();
            }, 100);
        }

        async function finalizeWorkOrder() {
            const workTitle = document.getElementById('workTitle').value.trim();
            const workDetails = document.getElementById('workDetails').value.trim();
            
            if (!workTitle || !workDetails) {
                alert('ì‘ì—…ëª…ê³¼ ì‘ì—…ìƒì„¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedRecommendation) {
                alert('ì„ íƒëœ ì¶”ì²œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/finalize-work-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        work_title: workTitle,
                        work_details: workDetails,
                        selected_recommendation: selectedRecommendation,
                        user_message: conversationHistory[conversationHistory.length - 2]?.content || '',
                        session_id: sessionId // ì„¸ì…˜ ID í¬í•¨
                    })
                });

                if (!response.ok) {
                    throw new Error('ìµœì¢… ì‘ì—…ìš”ì²­ ì™„ì„± ì‹¤íŒ¨');
                }

                const result = await response.json();
                
                // ëŒ€í™”ì°½ì— ì™„ì„±ëœ ì‘ì—…ìš”ì²­ ì •ë³´ í‘œì‹œ
                const completionMessage = `âœ… ${result.message}

ğŸ“‹ **ì‘ì—…ìš”ì²­ ìƒì„¸ì •ë³´**
â€¢ ì‘ì—…ìš”ì²­ë²ˆí˜¸: ${result.work_order.itemno}
â€¢ ì‘ì—…ëª…: ${result.work_order.work_title}
â€¢ ì‘ì—…ìƒì„¸: ${result.work_order.work_details}

ğŸ­ **ì‹œì„¤ì •ë³´**
â€¢ ê³µì •ëª…: ${result.work_order.process}
â€¢ ìœ„ì¹˜: ${result.work_order.location}
â€¢ ì„¤ë¹„: ${result.work_order.equipType}
â€¢ ìƒíƒœ: ${result.work_order.statusCode}

ì‘ì—…ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`;

                addMessageToChat('bot', completionMessage);
                
                // ì¶”ì²œ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                document.getElementById('recommendationsArea').innerHTML = 
                    '<div class="no-recommendations">ìƒˆë¡œìš´ ì‘ì—…ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
                
                // ìƒíƒœ ì´ˆê¸°í™”
                selectedRecommendation = null;
                currentRecommendations = [];
                
            } catch (error) {
                console.error('Error finalizing work order:', error);
                addMessageToChat('bot', 'ìµœì¢… ì‘ì—…ìš”ì²­ ì™„ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function startNewSession() {
            try {
                const response = await fetch(`${backendUrl}/session-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨');
                }

                const result = await response.json();
                sessionId = result.new_session_id;
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('sessionStatus').textContent = `ì„¸ì…˜ í™œì„± (${sessionId.substring(0, 8)}...)`;
                document.getElementById('sessionStatus').style.color = 'rgba(255, 255, 255, 0.9)';
                
                // ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                updateContextPanel(null);
                
                // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                conversationHistory = [];
                
                // ì±„íŒ… ë©”ì‹œì§€ ì´ˆê¸°í™” (í™˜ì˜ ë©”ì‹œì§€ ì œì™¸)
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                messages.forEach((msg, index) => {
                    if (index > 0) { // ì²« ë²ˆì§¸ í™˜ì˜ ë©”ì‹œì§€ëŠ” ìœ ì§€
                        msg.remove();
                    }
                });
                
                // ì¶”ì²œ ëª©ë¡ ì´ˆê¸°í™”
                document.getElementById('recommendationsArea').innerHTML = 
                    '<div class="no-recommendations">ì…ë ¥í•˜ì‹  ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìœ ì‚¬í•œ ì‘ì—…ìš”ì²­ ì´ë ¥ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</div>';
                
                console.log('ìƒˆ ì„¸ì…˜ ì‹œì‘:', sessionId);
                
                // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
                addMessageToChat('bot', 'ğŸ†• ìƒˆë¡œìš´ ì„¸ì…˜ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì‘ì—… ë‚´ìš©ì„ ë§ì”€í•´ì£¼ì„¸ìš”.');
                
            } catch (error) {
                console.error('ì„¸ì…˜ ì‹œì‘ ì˜¤ë¥˜:', error);
                document.getElementById('sessionStatus').textContent = 'ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨';
                document.getElementById('sessionStatus').style.color = 'rgba(255, 255, 255, 0.7)';
            }
        }

        function updateContextPanel(parsed_input) {
            // íŒŒì‹±ëœ ì…ë ¥ì´ ìˆìœ¼ë©´ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            if (parsed_input) {
                updateContextItem('contextLocation', parsed_input.location);
                updateContextItem('contextEquipment', parsed_input.equipment_type);
                updateContextItem('contextStatus', parsed_input.status_code);
                updateContextItem('contextPriority', parsed_input.priority);
            } else {
                // ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                updateContextItem('contextLocation', null);
                updateContextItem('contextEquipment', null);
                updateContextItem('contextStatus', null);
                updateContextItem('contextPriority', null);
            }
        }

        function updateContextItem(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = 'context-value';
            
            if (value && value !== "ì¼ë°˜ì‘ì—…") {
                element.textContent = value;
                element.classList.add('confirmed');
            } else {
                if (elementId === 'contextLocation') {
                    element.textContent = 'âŒ ë¯¸í™•ì¸';
                } else if (elementId === 'contextEquipment') {
                    element.textContent = 'âŒ ë¯¸í™•ì¸';
                } else if (elementId === 'contextStatus') {
                    element.textContent = 'âŒ ë¯¸í™•ì¸';
                } else if (elementId === 'contextPriority') {
                    element.textContent = 'âšª ë¯¸ì§€ì •';
                }
                element.classList.add('missing');
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isLoading) return;
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            messageInput.value = '';
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessageToChat('user', message);
            
            // ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: getCurrentTime()
            });

            // Show loading
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            const loadingMessage = addMessageToChat('bot', '', true);

            try {
                const response = await fetch(`${backendUrl}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory,
                        session_id: sessionId // ì„¸ì…˜ ID í¬í•¨
                    })
                });

                if (!response.ok) {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }

                const data = await response.json();
                
                // Remove loading message
                loadingMessage.remove();
                
                // Add bot response
                addBotResponse(data);
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: data.message,
                    timestamp: getCurrentTime()
                });
                
                // Update context panel with parsed input
                if (data.parsed_input) {
                    updateContextPanel(data.parsed_input);
                }
                
                // Show recommendations in right panel
                showRecommendations(data);
                
            } catch (error) {
                console.error('Error:', error);
                loadingMessage.querySelector('.message-bubble').textContent = 
                    'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                loadingMessage.querySelector('.loading')?.remove();
            } finally {
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addBotResponse(data) {
            const botMessage = addMessageToChat('bot', data.message);
            
            // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ í…ìŠ¤íŠ¸ ì²˜ë¦¬
            const messageContent = botMessage.querySelector('.message-bubble');
            if (messageContent) {
                messageContent.innerHTML = formatBotMessage(data.message);
            }
        }

        function formatBotMessage(message) {
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/â€¢/g, 'â€¢')
                .replace(/âŒ/g, '<span style="color: #dc3545;">âŒ</span>')
                .replace(/âœ…/g, '<span style="color: #28a745;">âœ…</span>')
                .replace(/ğŸ¯/g, '<span style="color: #007bff;">ğŸ¯</span>')
                .replace(/ğŸ“/g, '<span style="color: #6c757d;">ğŸ“</span>')
                .replace(/ğŸ’¡/g, '<span style="color: #ffc107;">ğŸ’¡</span>')
                .replace(/â—/g, '<span style="color: #fd7e14;">â—</span>');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            startNewSession(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒˆ ì„¸ì…˜ ì‹œì‘
        });
    </script>
</body>
</html> 