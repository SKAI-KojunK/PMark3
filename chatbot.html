<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMark1 - AI 작업요청 Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .session-controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .session-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        #sessionStatus {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .context-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px;
            font-size: 13px;
        }

        .context-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .context-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .context-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-label {
            font-weight: 500;
            color: #6c757d;
            min-width: 60px;
        }

        .context-value {
            color: #495057;
            font-weight: 400;
        }

        .context-value.confirmed {
            color: #28a745;
            font-weight: 500;
        }

        .context-value.missing {
            color: #dc3545;
            font-style: italic;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e9ecef;
        }

        .recommendations-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }

        .recommendations-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .recommendations-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #333;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.bot .message-bubble {
            background: #f1f3f4;
            border: 1px solid #e9ecef;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .recommendation-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .recommendation-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
        }

        .recommendation-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .recommendation-radio {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendation-radio.selected {
            border-color: #667eea;
        }

        .recommendation-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #667eea;
        }

        .recommendation-content {
            margin-right: 40px;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-itemno {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .recommendation-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .score-high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .score-medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
        }
        
        .score-low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%) !important;
        }

        .recommendation-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .recommendation-field {
            display: flex;
            flex-direction: column;
        }

        .recommendation-field label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .recommendation-field input {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            background: #f8f9fa;
        }

        .recommendation-field input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .input-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .examples-section {
            background: #f8f9fa;
            padding: 15px 20px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .examples-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .examples-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .example-item:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .input-field {
            flex: 1;
        }

        .input-field input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-field input:focus {
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .complete-btn {
            background: linear-gradient(135deg, #6bcf7f 0%, #4caf50 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .complete-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .work-details-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .work-details-header {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .work-field {
            margin-bottom: 15px;
        }

        .work-field label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .work-field input,
        .work-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .work-field textarea {
            height: 80px;
            resize: vertical;
        }

        .work-field input:focus,
        .work-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .no-recommendations {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PMark1 - AI 작업요청 Assistant</h1>
            <p>자연어로 작업요청을 입력하면 AI가 유사한 이력을 찾아 추천해드립니다</p>
            <div class="session-controls">
                <div class="session-info">
                    <span id="sessionStatus">세션 준비 중...</span>
                    <button class="session-btn" onclick="startNewSession()">새 세션</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="context-panel" id="contextPanel">
                    <div class="context-header">📝 수집된 정보</div>
                    <div class="context-content" id="contextContent">
                        <div class="context-item">
                            <span class="context-label">위치:</span>
                            <span class="context-value" id="contextLocation">❌ 미확인</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">설비유형:</span>
                            <span class="context-value" id="contextEquipment">❌ 미확인</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">현상코드:</span>
                            <span class="context-value" id="contextStatus">❌ 미확인</span>
                        </div>
                        <div class="context-item">
                            <span class="context-label">우선순위:</span>
                            <span class="context-value" id="contextPriority">⚪ 미지정</span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        <div class="message-bubble">
                            안녕하세요! PMark1 AI Assistant입니다. 🚀<br><br>
                            작업요청을 자연어로 입력해주세요. 예시:<br>
                            • "No.1 PE의 Pressure Vessel에 고장 발생"<br>
                            • "44043-CA1-6\"-P, Leak 볼팅 작업"<br>
                            • "석유제품배합/저장의 Motor Operated Valve, 작동불량"<br><br>
                            💡 <strong>멀티턴 대화 지원:</strong> 정보를 단계별로 입력하셔도 됩니다!<br>
                            예: "No.1 PE" → "압력베젤" → "고장"
                        </div>
                        <div class="message-time" id="currentTime"></div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="examples-section">
                        <div class="examples-title">💡 입력 예시</div>
                        <div class="examples-list">
                            <div class="example-item" onclick="useExample(this)">No.1 PE의 Pressure Vessel에 고장 발생</div>
                            <div class="example-item" onclick="useExample(this)">석유제품배합/저장의 Motor Operated Valve, 작동불량</div>
                            <div class="example-item" onclick="useExample(this)">44043-CA1-6"-P, Leak 볼팅 작업</div>
                            <div class="example-item" onclick="useExample(this)">합성수지 포장, Conveyor, 고장</div>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-field">
                            <input type="text" id="messageInput" placeholder="작업요청을 자연어로 입력하세요..." onkeypress="handleKeyPress(event)">
                        </div>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">전송</button>
                    </div>
                </div>
            </div>

            <div class="recommendations-section">
                <div class="recommendations-header">
                    📋 추천 작업요청 이력
                </div>
                <div class="recommendations-area" id="recommendationsArea">
                    <div class="no-recommendations">입력하신 내용을 분석하여 유사한 작업요청 이력을 추천해드립니다.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let conversationHistory = [];
        let currentRecommendations = [];
        let selectedRecommendation = null;
        let isLoading = false;
        let sessionId = null; // 세션 ID 추적

        // 백엔드 URL (기존 프로젝트와 충돌 방지를 위해 포트 변경)
        // 백엔드 URL 설정 (환경에 따라 자동 감지)
        const getBackendUrl = () => {
            const currentPort = window.location.port;
            const currentHost = window.location.hostname;
            
            // 프론트엔드가 3001 포트에서 실행 중이면 백엔드는 8001
            if (currentPort === '3001') {
                return `http://${currentHost}:8001/api/v1`;
            }
            // 프론트엔드가 3000 포트에서 실행 중이면 백엔드는 8000
            else if (currentPort === '3000') {
                return `http://${currentHost}:8000/api/v1`;
            }
            // 기본값
            else {
                return `http://${currentHost}:8001/api/v1`;
            }
        };
        
        const backendUrl = getBackendUrl();

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR');
            document.getElementById('currentTime').textContent = timeString;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('ko-KR');
        }

        function useExample(element) {
            const text = element.textContent;
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        function addMessageToChat(type, content, isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (isLoading) {
                bubbleDiv.innerHTML = '<div class="loading">답변을 생성하고 있습니다</div>';
            } else {
                bubbleDiv.textContent = content;
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = getCurrentTime();
            
            messageDiv.appendChild(bubbleDiv);
            messageDiv.appendChild(timeDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        function showRecommendations(data) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsArea.innerHTML = '';
                
                data.recommendations.forEach((rec, index) => {
                    const recDiv = createRecommendationElement(rec, index);
                    recommendationsArea.appendChild(recDiv);
                });
                
                // Add complete button
                const completeBtnDiv = document.createElement('div');
                completeBtnDiv.innerHTML = `
                    <button class="complete-btn" onclick="completeWorkOrder()" disabled>
                        작성 완료
                    </button>
                `;
                recommendationsArea.appendChild(completeBtnDiv);
                
                currentRecommendations = data.recommendations;
            } else {
                recommendationsArea.innerHTML = '<div class="no-recommendations">추천 결과가 없습니다.</div>';
            }
        }

        function createRecommendationElement(rec, index) {
            const recDiv = document.createElement('div');
            recDiv.className = 'recommendation-item';
            recDiv.onclick = () => selectRecommendation(index);
            
            // 유사도 점수를 퍼센트로 표시하고 색상으로 구분
            const scorePercent = Math.round(rec.score * 100);
            let scoreClass = 'score-low';
            if (scorePercent >= 80) scoreClass = 'score-high';
            else if (scorePercent >= 60) scoreClass = 'score-medium';
            
            recDiv.innerHTML = `
                <div class="recommendation-radio" id="radio-${index}"></div>
                <div class="recommendation-content">
                    <div class="recommendation-header">
                        <div class="recommendation-itemno">
                            <label>ITEMNO</label>
                            <input type="text" value="${rec.itemno}" onchange="updateRecommendation(${index}, 'itemno', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-score ${scoreClass}">${scorePercent}%</div>
                    </div>
                    <div class="recommendation-details">
                        <div class="recommendation-field">
                            <label>위치</label>
                            <input type="text" value="${rec.location}" onchange="updateRecommendation(${index}, 'location', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>설비유형</label>
                            <input type="text" value="${rec.equipType}" onchange="updateRecommendation(${index}, 'equipType', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>현상코드</label>
                            <input type="text" value="${rec.statusCode}" onchange="updateRecommendation(${index}, 'statusCode', this.value)" onclick="event.stopPropagation()">
                        </div>
                        <div class="recommendation-field">
                            <label>우선순위</label>
                            <input type="text" value="${rec.priority}" onchange="updateRecommendation(${index}, 'priority', this.value)" onclick="event.stopPropagation()">
                        </div>
                    </div>
                </div>
            `;
            
            return recDiv;
        }

        function selectRecommendation(index) {
            // Remove previous selection
            document.querySelectorAll('.recommendation-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.recommendation-radio').forEach(radio => {
                radio.classList.remove('selected');
            });
            
            // Add new selection
            const selectedItem = document.querySelectorAll('.recommendation-item')[index];
            const selectedRadio = document.getElementById(`radio-${index}`);
            
            selectedItem.classList.add('selected');
            selectedRadio.classList.add('selected');
            
            selectedRecommendation = { ...currentRecommendations[index] };
            
            // Enable complete button
            document.querySelector('.complete-btn').disabled = false;
        }

        function updateRecommendation(index, field, value) {
            currentRecommendations[index][field] = value;
            if (selectedRecommendation && document.querySelectorAll('.recommendation-item')[index].classList.contains('selected')) {
                selectedRecommendation[field] = value;
            }
        }

        async function completeWorkOrder() {
            if (!selectedRecommendation) return;
            
            try {
                // 기존 작업요청 완성 대신 작업명/상세 생성
                const response = await fetch(`${backendUrl}/generate-work-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_recommendation: selectedRecommendation,
                        user_message: conversationHistory[conversationHistory.length - 2]?.content || '',
                        session_id: sessionId // 세션 ID 포함
                    })
                });

                if (!response.ok) {
                    throw new Error('작업명/상세 생성 실패');
                }

                const result = await response.json();
                
                // 추천 결과 영역을 작업명/상세 편집 영역으로 변경
                showWorkDetailsEditor(result);
                
                // 대화창에 안내 메시지 추가
                addMessageToChat('bot', '작업명과 작업상세내용을 확인하고 수정해주세요. 완료되면 "확정" 버튼을 눌러주세요.');
                
            } catch (error) {
                console.error('Error generating work details:', error);
                addMessageToChat('bot', '작업명/상세 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        function showWorkDetailsEditor(workDetails) {
            const recommendationsArea = document.getElementById('recommendationsArea');
            
            recommendationsArea.innerHTML = `
                <div class="work-details-section">
                    <div class="work-details-header">
                        📝 작업명과 작업상세를 확인하고 수정해주세요
                    </div>
                    
                    <div class="work-field">
                        <label for="workTitle">작업명</label>
                        <input type="text" id="workTitle" value="${workDetails.work_title}" placeholder="작업명을 입력하세요">
                    </div>
                    
                    <div class="work-field">
                        <label for="workDetails">작업상세</label>
                        <textarea id="workDetails" placeholder="작업상세를 입력하세요">${workDetails.work_details}</textarea>
                    </div>
                    
                    <button class="confirm-btn" onclick="finalizeWorkOrder()">
                        확정
                    </button>
                </div>
            `;
            
            // 입력 필드에 포커스
            setTimeout(() => {
                document.getElementById('workTitle').focus();
            }, 100);
        }

        async function finalizeWorkOrder() {
            const workTitle = document.getElementById('workTitle').value.trim();
            const workDetails = document.getElementById('workDetails').value.trim();
            
            if (!workTitle || !workDetails) {
                alert('작업명과 작업상세를 모두 입력해주세요.');
                return;
            }
            
            if (!selectedRecommendation) {
                alert('선택된 추천이 없습니다.');
                return;
            }
            
            try {
                const response = await fetch(`${backendUrl}/finalize-work-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        work_title: workTitle,
                        work_details: workDetails,
                        selected_recommendation: selectedRecommendation,
                        user_message: conversationHistory[conversationHistory.length - 2]?.content || '',
                        session_id: sessionId // 세션 ID 포함
                    })
                });

                if (!response.ok) {
                    throw new Error('최종 작업요청 완성 실패');
                }

                const result = await response.json();
                
                // 대화창에 완성된 작업요청 정보 표시
                const completionMessage = `✅ ${result.message}

📋 **작업요청 상세정보**
• 작업요청번호: ${result.work_order.itemno}
• 작업명: ${result.work_order.work_title}
• 작업상세: ${result.work_order.work_details}

🏭 **시설정보**
• 공정명: ${result.work_order.process}
• 위치: ${result.work_order.location}
• 설비: ${result.work_order.equipType}
• 상태: ${result.work_order.statusCode}

작업요청이 성공적으로 완성되었습니다!`;

                addMessageToChat('bot', completionMessage);
                
                // 추천 결과 영역 초기화
                document.getElementById('recommendationsArea').innerHTML = 
                    '<div class="no-recommendations">새로운 작업요청을 입력해주세요.</div>';
                
                // 상태 초기화
                selectedRecommendation = null;
                currentRecommendations = [];
                
            } catch (error) {
                console.error('Error finalizing work order:', error);
                addMessageToChat('bot', '최종 작업요청 완성 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        async function startNewSession() {
            try {
                const response = await fetch(`${backendUrl}/session-reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('세션 시작 실패');
                }

                const result = await response.json();
                sessionId = result.new_session_id;
                
                // UI 업데이트
                document.getElementById('sessionStatus').textContent = `세션 활성 (${sessionId.substring(0, 8)}...)`;
                document.getElementById('sessionStatus').style.color = 'rgba(255, 255, 255, 0.9)';
                
                // 컨텍스트 초기화
                updateContextPanel(null);
                
                // 대화 히스토리 초기화
                conversationHistory = [];
                
                // 채팅 메시지 초기화 (환영 메시지 제외)
                const chatMessages = document.getElementById('chatMessages');
                const messages = chatMessages.querySelectorAll('.message');
                messages.forEach((msg, index) => {
                    if (index > 0) { // 첫 번째 환영 메시지는 유지
                        msg.remove();
                    }
                });
                
                // 추천 목록 초기화
                document.getElementById('recommendationsArea').innerHTML = 
                    '<div class="no-recommendations">입력하신 내용을 분석하여 유사한 작업요청 이력을 추천해드립니다.</div>';
                
                console.log('새 세션 시작:', sessionId);
                
                // 환영 메시지 추가
                addMessageToChat('bot', '🆕 새로운 세션이 시작되었습니다! 작업 내용을 말씀해주세요.');
                
            } catch (error) {
                console.error('세션 시작 오류:', error);
                document.getElementById('sessionStatus').textContent = '세션 시작 실패';
                document.getElementById('sessionStatus').style.color = 'rgba(255, 255, 255, 0.7)';
            }
        }

        function updateContextPanel(parsed_input) {
            // 파싱된 입력이 있으면 컨텍스트 업데이트
            if (parsed_input) {
                updateContextItem('contextLocation', parsed_input.location);
                updateContextItem('contextEquipment', parsed_input.equipment_type);
                updateContextItem('contextStatus', parsed_input.status_code);
                updateContextItem('contextPriority', parsed_input.priority);
            } else {
                // 컨텍스트 초기화
                updateContextItem('contextLocation', null);
                updateContextItem('contextEquipment', null);
                updateContextItem('contextStatus', null);
                updateContextItem('contextPriority', null);
            }
        }

        function updateContextItem(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.className = 'context-value';
            
            if (value && value !== "일반작업") {
                element.textContent = value;
                element.classList.add('confirmed');
            } else {
                if (elementId === 'contextLocation') {
                    element.textContent = '❌ 미확인';
                } else if (elementId === 'contextEquipment') {
                    element.textContent = '❌ 미확인';
                } else if (elementId === 'contextStatus') {
                    element.textContent = '❌ 미확인';
                } else if (elementId === 'contextPriority') {
                    element.textContent = '⚪ 미지정';
                }
                element.classList.add('missing');
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isLoading) return;
            
            // 입력창 초기화
            messageInput.value = '';
            
            // 사용자 메시지 추가
            addMessageToChat('user', message);
            
            // 대화 히스토리에 추가
            conversationHistory.push({
                role: 'user',
                content: message,
                timestamp: getCurrentTime()
            });

            // Show loading
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            const loadingMessage = addMessageToChat('bot', '', true);

            try {
                const response = await fetch(`${backendUrl}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory,
                        session_id: sessionId // 세션 ID 포함
                    })
                });

                if (!response.ok) {
                    throw new Error('서버 응답 오류');
                }

                const data = await response.json();
                
                // Remove loading message
                loadingMessage.remove();
                
                // Add bot response
                addBotResponse(data);
                
                // Add to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: data.message,
                    timestamp: getCurrentTime()
                });
                
                // Update context panel with parsed input
                if (data.parsed_input) {
                    updateContextPanel(data.parsed_input);
                }
                
                // Show recommendations in right panel
                showRecommendations(data);
                
            } catch (error) {
                console.error('Error:', error);
                loadingMessage.querySelector('.message-bubble').textContent = 
                    '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.';
                loadingMessage.querySelector('.loading')?.remove();
            } finally {
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addBotResponse(data) {
            const botMessage = addMessageToChat('bot', data.message);
            
            // 마크다운 스타일 텍스트 처리
            const messageContent = botMessage.querySelector('.message-bubble');
            if (messageContent) {
                messageContent.innerHTML = formatBotMessage(data.message);
            }
        }

        function formatBotMessage(message) {
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/•/g, '•')
                .replace(/❌/g, '<span style="color: #dc3545;">❌</span>')
                .replace(/✅/g, '<span style="color: #28a745;">✅</span>')
                .replace(/🎯/g, '<span style="color: #007bff;">🎯</span>')
                .replace(/📝/g, '<span style="color: #6c757d;">📝</span>')
                .replace(/💡/g, '<span style="color: #ffc107;">💡</span>')
                .replace(/❗/g, '<span style="color: #fd7e14;">❗</span>');
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            startNewSession(); // 페이지 로드 시 새 세션 시작
        });
    </script>
</body>
</html> 